{% load staticfiles %}<!DOCTYPE html>
<html>
<head>
<title>Leaderboard</title>
<style>
    /*Reset*/
    a,abbr,acronym,address,applet,big,blockquote,body,caption,cite,code,dd,del,dfn,div,dl,dt,em,fieldset,font,form,h1,h2,h3,h4,h5,h6,html,iframe,img,ins,kbd,label,legend,li,object,ol,p,pre,q,s,samp,small,span,strike,strong,sub,sup,table,tbody,td,tfoot,th,thead,tr,tt,ul,var{margin:0;padding:0;border:0;outline:0;font-weight:inherit;font-style:inherit;font-size:100%;font-family:inherit;vertical-align:baseline}:focus{outline:0}body{line-height:1;color:#000;background:#fff}ol,ul{list-style:none}table{border-collapse:separate;border-spacing:0}caption,td,th{text-align:left;font-weight:400}blockquote:after,blockquote:before,q:after,q:before{content:""}blockquote,q{quotes:"" ""}
    html,body {
        height: 100%;
        box-sizing: border-box;
    }
    *, *:before, *:after {
      box-sizing: inherit;
    }
    body {
        display: -webkit-flex;
        display: flex;

        -webkit-align-items: center;
        align-items: center;
        -webkit-justify-content: center;
        justify-content: center;

        background: #7abcff; /* Old browsers */
        background: -moz-linear-gradient(top,  #7abcff 0%, #60abf8 44%, #4096ee 100%); /* FF3.6+ */
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#7abcff), color-stop(44%,#60abf8), color-stop(100%,#4096ee)); /* Chrome,Safari4+ */
        background: -webkit-linear-gradient(top,  #7abcff 0%,#60abf8 44%,#4096ee 100%); /* Chrome10+,Safari5.1+ */
        background: -o-linear-gradient(top,  #7abcff 0%,#60abf8 44%,#4096ee 100%); /* Opera 11.10+ */
        background: -ms-linear-gradient(top,  #7abcff 0%,#60abf8 44%,#4096ee 100%); /* IE10+ */
        background: linear-gradient(to bottom,  #7abcff 0%,#60abf8 44%,#4096ee 100%); /* W3C */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#7abcff', endColorstr='#4096ee',GradientType=0 ); /* IE6-9 */
    }

    #main {
        -webkit-flex: 1;
        flex: 1;

        max-width: 90%;
        height: 90%;

        padding: 5vh 10vw;

        background: rgb(53,106,160); /* Old browsers */
        background: -moz-linear-gradient(top,  rgba(53,106,160,1) 0%, rgba(53,106,160,1) 100%); /* FF3.6+ */
        background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,rgba(53,106,160,1)), color-stop(100%,rgba(53,106,160,1))); /* Chrome,Safari4+ */
        background: -webkit-linear-gradient(top,  rgba(53,106,160,1) 0%,rgba(53,106,160,1) 100%); /* Chrome10+,Safari5.1+ */
        background: -o-linear-gradient(top,  rgba(53,106,160,1) 0%,rgba(53,106,160,1) 100%); /* Opera 11.10+ */
        background: -ms-linear-gradient(top,  rgba(53,106,160,1) 0%,rgba(53,106,160,1) 100%); /* IE10+ */
        background: linear-gradient(to bottom,  rgba(53,106,160,1) 0%,rgba(53,106,160,1) 100%); /* W3C */
        filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#356aa0', endColorstr='#356aa0',GradientType=0 ); /* IE6-9 */

        border: 3px solid white;
        -webkit-border-radius: 5%;
        -moz-border-radius: 5%;
        border-radius: 5%;

        -webkit-box-shadow: inset 5px 5px 5px 0px rgba(0,0,0,0.75);
        -moz-box-shadow: inset 5px 5px 5px 0px rgba(0,0,0,0.75);
        box-shadow: inset 5px 5px 5px 0px rgba(0,0,0,0.75);

        font-size: 6vh;
    }

    #main > header {
        font-family: "Arial Black", Gadget, sans-serif;
        color: #DAA520;
        text-shadow: 2px 2px 2px rgba(0, 0, 0, 1);
        font-size: 10vh;

        text-transform: uppercase;
        text-align: center;
    }

    #board {
        font-family: Arial, Helvetica, sans-serif;

        margin: 0.5em auto;
        width: 90%;

        color: white;
        text-shadow: 0px 0px 4px rgba(255, 255, 81, 1);
    }

    #board th {
        text-transform: uppercase;
        font-weight: bold;
    }

    #board th,
    #board td {
        line-height: 1.8;
        text-align: center;
    }

    #board .playername {
        text-align: left;
    }
    #board .score {
        text-align: right;
    }

    #board button.inc {
        font-size: 5vh;
    }
</style>
<link rel="stylesheet" href="{% static 'odometer-theme-default.css' %}" />
</head>
<body>

<section id="main">
    <header>Leaderboard</header>

    <table id="board">
        <thead>
        <tr>
            <th>Player</th>
            <th>Score</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        <!-- ko foreach: players -->
            <tr class="knockout">
                <td class="playername" data-bind="text: playerName"></td>
                <td class="score"><span data-bind="odometer: score"></span></td>
                <td>
                    <button class="inc" type="button" data-bind="click: $parent.incrementScore, disable: incrementing">+1</button>
                </td>
            </tr>
        <!-- /ko -->
        </tbody>
    </table>

</section>

<script src="{% static 'jquery-1.11.2.min.js' %}"></script>
<script src="{% static 'knockoutjs-3.3.0.js' %}"></script>
<script src="{% static 'eventsource.min.js' %}"></script>
<script src="{% static 'odometer.min.js' %}"></script>
<script>

    (function() {

        var playerData = [
            {% for player in players %}
                { "id": "{{ player.id }}", "playerName": "{{ player.name }}", "score": {{ player.score }} }
                {% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Only going to use first five
        playerData = playerData.slice(0, 5);

        var PlayerViewModel = function(id, playerName, score) {
            this.id = id;
            this.playerName = playerName;
            this.score = ko.observable(score);
            this.incrementing = ko.observable(false);
        };

        var ViewModel = function(data) {
            var viewModel = this;
            var playerViewModels = $.map(data, function(e) { return new PlayerViewModel(e.id, e.playerName, e.score); });
            viewModel.players = ko.observableArray(playerViewModels);

            var findPlayer = function(id) {
                var player = null;
                $.each(viewModel.players(), function(i, e) {
                    if (id === e.id) {
                        player = e;
                        return false;
                    }
                    return true;
                });
                return player;
            };

            this.updateScores = function(rows, resize) {
                if (resize) {
                    // This means the items in the existing list need to be
                    // updated to match the items in the incoming rows
                    var newPlayers = [];
                    $.each(rows, function (i, row) {
                        var player = findPlayer(row.id);
                        if (player !== null) {
                            // already exists, use it
                            newPlayers.push(player);
                        } else {
                            newPlayers.push(new PlayerViewModel(row.id, row.name, row.score));
                        }
                    });
                    viewModel.players(newPlayers);
                }

                $.each(rows, function(i, row) {
                    var player = findPlayer(row.id);
                    player.score(row.score);
                });

                // Sort, as order may have changed
                viewModel.players().sort(function(a, b) {
                    // We want items with higher values to appear first, so it's
                    // a descending sort
                    if (a.score() > b.score()) {
                        return -1;
                    }
                    if (a.score() < b.score()) {
                        return 1;
                    }
                    return a.playerName.localeCompare(b.playerName);
                });
                viewModel.players.valueHasMutated();

            };

            viewModel.incrementScore = function(player) {
                player.incrementing(true);
                var post = $.ajax({
                    type: 'POST',
                    url: '{{ board_uri }}/players/' + player.id + '/score-add/',
                    dataType: 'json'
                });

                post.always(function () {
                    player.incrementing(false);
                });
                post.done(function (data) {
                    window.setTimeout(function() {
                        viewModel.updateScores([data], false);
                    }, 0);
                });
            };
        };

        ko.bindingHandlers.odometer = {
            'init': function(element, valueAccessor) {
                var value = ko.unwrap(valueAccessor());
                $(element).data("odometer", new Odometer({
                    el: element,
                    value: value
                }));
            },
            'update': function (element, valueAccessor) {
                var odometer = $(element).data("odometer");
                var value = ko.unwrap(valueAccessor());
                if (value > odometer.value) {
                    odometer.update(value);
                }
            }
        };

        var viewModel = new ViewModel(playerData);
        ko.applyBindings(viewModel, $("#board")[0]);

        var es = new EventSource('{{ board_uri }}/');
        es.addEventListener('update', function (e) {
            var data = JSON.parse(e.data);
            // Only going to use first 5
            var playerData = data.players.slice(0, 5);
            viewModel.updateScores(playerData, true);
        }, false);

    })();

</script>

</body>
</html>
